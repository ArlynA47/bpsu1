<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="../images/hirna-logo.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="../css/output.css">
    <title>HirNa!</title>
</head>

<body class="min-h-screen flex flex-col">
    <!-- Login Prompt (to be added) -->
    <div id="loginPrompt"
        class="fixed inset-0 bg-white bg-opacity-90 flex flex-col items-center justify-center z-50 hidden">
        <div class="text-center p-8 max-w-md">
            <h3 class="text-2xl font-bold mb-4">Please log in to browse jobs</h3>
            <p class="mb-6">You need to be logged in to save your liked jobs</p>
            <button id="goToLoginBtn" class="bg-[#315E26] text-white px-6 py-2 rounded hover:bg-[#3F742F]">
                Go to Login Page
            </button>
        </div>
    </div>

    <!-- Navigation Bar -->
    <nav class="flex justify-between bg-[#232323] py-2.5 px-10">
        <div class="flex flex-1 justify-start items-end gap-2 ">
            <img src="../images/hirna-logo.png" alt="HirNa Logo" class="h-10 w-10">
        </div>

        <div class="flex flex-2 justify-between items-center gap-6">
            <a href="./employee-home.html" class="flex-1 text-center text-white hover:text-gray-300">Home</a>
            <a href="./employee-browse-jobs.html" class="flex-1 text-center text-white hover:text-gray-300">Browse
                Jobs</a>
            <a href="./to-nurture.html" class="flex-1 text-center text-white hover:text-gray-300">Liked
                Jobs</a>
        </div>

        <div class="flex flex-1 justify-end items-center gap-4">
            <a href="./employer-profile.html"
                class="bg-[#315E26] text-white px-4 py-2 rounded hover:bg-[#3F742F] cursor-pointer">
                Profile
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col items-center gap-6 p-10">
        <div class="flex flex-col items-center gap-1">
            <h3 class="text-[#3D3D3D] text-3xl font-semibold">Find Your Dream Job</h3>
            <p class="text-[#545454] text-xl">
                Click <i class="fas fa-heart text-[#73A267] text-xl"></i> to Keep,
                Click <i class="fas fa-times text-[#D33B3B] text-xl"></i> to Skip
            </p>
        </div>

        <div class="flex flex-col items-center justify-between flex-1 w-[55%] gap-8">
            <!-- No Jobs Message (to be added) -->
            <div id="noJobsMessage" class="text-center hidden">
                <i class="fas fa-seedling fa-3x mb-3 text-[#65956C]"></i>
                <h4 class="text-xl font-semibold">No job opportunities available</h4>
                <p class="text-gray-600">Check back later for new postings</p>
            </div>

            <!-- Job Listing Card (will be dynamically populated) -->
            <div id="jobCardsContainer" class="job-listing-card">
                <!-- Content will be generated by JavaScript -->
            </div>

            <!-- Button Card -->
            <div
                class="h-[100px] w-[60%] bg-[#F7FFF9] rounded-xl border-3 border-[#65956C] p-4 flex justify-center shadow-xl gap-24">
                <!-- Skip Button -->
                <button id="passBtn"
                    class="h-auto w-[15%] bg-[#D33B3B] rounded-full p-4 hover:bg-[#b32f2f] cursor-pointer">
                    <i class="fas fa-times text-2xl text-white"></i>
                </button>

                <!-- Keep Button -->
                <button id="nurtureBtn"
                    class="h-auto w-[15%] bg-[#73A267] rounded-full p-4 hover:bg-[#5c8651] cursor-pointer">
                    <i class="fas fa-heart text-2xl text-white"></i>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, doc, getDoc, setDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCM1QSKbZH9Ih3RHv39nQipYoti8Yrji_M",
            authDomain: "careerstep-bpsu1.firebaseapp.com",
            projectId: "careerstep-bpsu1",
            storageBucket: "careerstep-bpsu1.firebasestorage.app",
            messagingSenderId: "17047315291",
            appId: "1:17047315291:web:dc2c9312e3d5b0ced5307e",
            measurementId: "G-WH6DT9HQW2"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables
        let currentUser = null;
        let userSkills = [];
        let availableSeeds = [];
        let currentSeedIndex = 0;
        let nurturedSeedIds = new Set();
        let appliedJobIds = new Set();

        // DOM Elements
        const loadingScreen = document.getElementById('loadingScreen');
        const loginPrompt = document.getElementById('loginPrompt');
        const jobCardsContainer = document.getElementById('jobCardsContainer');
        const noJobsMessage = document.getElementById('noJobsMessage');
        const passBtn = document.getElementById('passBtn');
        const nurtureBtn = document.getElementById('nurtureBtn');
        const goToLoginBtn = document.getElementById('goToLoginBtn');

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            // Check auth state
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    await loadUserProfile();
                    await loadNurturedSeeds();
                    await loadAppliedJobs();
                    await loadJobSeeds();
                    showApp();
                } else {
                    showLoginPrompt();
                }
            });

            // Event listeners
            passBtn.addEventListener('click', passCurrentSeed);
            nurtureBtn.addEventListener('click', nurtureCurrentSeed);

            if (goToLoginBtn) {
                goToLoginBtn.addEventListener('click', () => {
                    window.location.href = 'login.html';
                });
            }

            // Touch events for swipe gestures
            let touchStartX = 0;
            let touchEndX = 0;

            // Then modify the event listeners to use these global variables:
            jobCardsContainer.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            }, false);

            jobCardsContainer.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            }, false);
        });

        // Load user profile from Firestore
        async function loadUserProfile() {
            try {
                const userDoc = await getDoc(doc(db, 'careerstepEmployees', currentUser.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    userSkills = userData.jobPreferences?.skills || [];
                } else {
                    console.error('User profile not found');
                    window.location.href = 'profile-setup.html';
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
            }
        }

        // Load nurtured seeds from Firestore
        async function loadNurturedSeeds() {
            try {
                const userDoc = await getDoc(doc(db, 'careerstepEmployees', currentUser.uid));
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    nurturedSeedIds = new Set((data.nurturedSeeds || []).map(seed => seed.id));
                } else {
                    nurturedSeedIds = new Set();
                }
            } catch (e) {
                nurturedSeedIds = new Set();
            }
        }

        // Load applied jobs from Firestore
        async function loadAppliedJobs() {
            try {
                const q = query(collection(db, 'applications'), where('applicantId', '==', currentUser.uid));
                const querySnapshot = await getDocs(q);
                appliedJobIds = new Set();
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.jobId) appliedJobIds.add(data.jobId);
                });
            } catch (e) {
                appliedJobIds = new Set();
            }
        }

        // Load job seeds that match the user's skills
        async function loadJobSeeds() {
            try {
                // Get jobs from employers who liked this employee
                let prioritizedJobs = [];
                const employeeDoc = await getDoc(doc(db, 'careerstepEmployees', currentUser.uid));
                if (employeeDoc.exists()) {
                    const employeeData = employeeDoc.data();
                    const likedByEmployers = employeeData.likedByEmployers || [];
                    
                    if (likedByEmployers.length > 0) {
                        const employerIds = [...new Set(likedByEmployers.map(like => like.employerId))];
                        const jobsQuery = query(
                            collection(db, 'jobSeeds'),
                            where('employerId', 'in', employerIds),
                            where('status', '==', 'active')
                        );
                        const jobsSnapshot = await getDocs(jobsQuery);
                        
                        prioritizedJobs = jobsSnapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data(),
                            isPriority: true, // Mark as priority
                            matchingSkills: getMatchingSkills(doc.data().skills)
                        })).filter(seed => {
                            // Only include priority jobs that match skills OR have no skills required
                            return seed.matchingSkills.length > 0 || !seed.skills || seed.skills.length === 0;
                        });
                    }
                }

                // Get other jobs that match skills
                let otherJobs = [];
                const seedsQuery = query(
                    collection(db, 'jobSeeds'),
                    where('status', '==', 'active')
                );
                const seedsSnapshot = await getDocs(seedsQuery);
                
                seedsSnapshot.forEach((doc) => {
                    const seedData = doc.data();
                    const matchingSkills = getMatchingSkills(seedData.skills);
                    
                    // Only include if:
                    // 1. Not already in prioritizedJobs
                    // 2. Not already nurtured
                    // 3. Not already applied
                    // 4. Either has matching skills OR no skills required
                    if (!prioritizedJobs.some(j => j.id === doc.id) && 
                        !nurturedSeedIds.has(doc.id) && 
                        !appliedJobIds.has(doc.id) &&
                        (matchingSkills.length > 0 || !seedData.skills || seedData.skills.length === 0)) {
                        
                        otherJobs.push({
                            id: doc.id,
                            ...seedData,
                            isPriority: false,
                            matchingSkills: matchingSkills
                        });
                    }
                });

                // Combine and sort (prioritized first)
                availableSeeds = [...prioritizedJobs, ...otherJobs];

                if (availableSeeds.length > 0) {
                    displayCurrentSeed();
                } else {
                    jobCardsContainer.innerHTML = '';
                    noJobsMessage.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading job seeds:', error);
                jobCardsContainer.innerHTML = '';
                noJobsMessage.classList.remove('hidden');
            }
        }

        // Get matching skills between job and user
        function getMatchingSkills(jobSkills) {
            if (!jobSkills || jobSkills.length === 0) return [];
            if (userSkills.length === 0) return [];

            return jobSkills.filter(skill =>
                userSkills.some(userSkill =>
                    userSkill.toLowerCase().includes(skill.toLowerCase()) ||
                    skill.toLowerCase().includes(userSkill.toLowerCase())
                )
            );
        }

        // Display current job seed card
        function displayCurrentSeed() {
            if (currentSeedIndex >= availableSeeds.length) {
                jobCardsContainer.innerHTML = `
                    <div class="text flex flex-col items-center justify-center">
                        <i class="fas fa-check fa-3x mb-3 text-[#65956C]"></i>
                        <h4 class="text-xl font-semibold">You're all caught up!</h4>
                        <p class="text-gray-600">Check back later for new job matchings</p>
                    </div>
                `;

                // Disable buttons
                nurtureBtn.disabled = true;
                passBtn.disabled = true;
                nurtureBtn.classList.add('opacity-50');
                passBtn.classList.add('opacity-50');

                return;
            }

            noJobsMessage.classList.add('hidden');
            const seed = availableSeeds[currentSeedIndex];
            const isNurtured = nurturedSeedIds.has(seed.id);
            const isApplied = appliedJobIds.has(seed.id);

            // Format the job card HTML to match the employee-browse-jobs.html structure
           const seedCardHTML = `
            <div class="flex flex-col gap-1 md:flex-row md:items-start md:justify-between md:gap-5">
                <div class="flex flex-col">
                    <span class="text-[#3D3D3D] text-xl font-bold overflow-hidden whitespace-nowrap text-ellipsis">
                        ${seed.jobTitle}
                    </span>
                    <span class="text-[#3D3D3D] text-md overflow-hidden whitespace-nowrap text-ellipsis flex items-center gap-1">
                        ${seed.employerEmail || 'N/A'}
                    </span>
                </div>

                <span class="text-[#3D3D3D] text-sm flex items-center gap-1 mt-1 md:mt-0 shrink-0 whitespace-nowrap">
                    <i class="far fa-clock text-[#3D3D3D] text-xs"></i>
                    Posted ${formatPostDate(seed.createdAt.toDate())}
                </span>
            </div>

            <div class="flex flex-col gap-2 mt-4">
                <h3 class="text-[#65956C] text-lg font-bold">Job Offer</h3>
                <p class="text-[#3D3D3D] text-md leading-relaxed">${seed.offer || 'No offer details provided'}</p>
            </div>

            <div class="flex flex-col gap-2 mt-4">
                <h3 class="text-[#65956C] text-lg font-bold">Job Location</h3>
                <div class="grid grid-cols-3 gap-2 w-full overflow-y-auto pr-1 max-h-[6.5rem] scroll-smooth">
                    <span class="text-center text-md p-2 border border-gray-300 bg-white rounded-md">${seed.location || 'N/A'}</span>
                </div>
            </div>

            <div class="flex flex-col gap-2 mt-4">
                <div class="flex items-center gap-8">
                    <h3 class="text-[#65956C] text-lg font-bold">Skills Required</h3>
                    ${seed.matchingSkills.length > 0 ? `
                        <span class="text-center text-xs px-2 py-1 bg-[#65956C] text-white rounded-md">
                            ${seed.matchingSkills.length} Match${seed.matchingSkills.length > 1 ? 'es' : ''}
                        </span>` : ''}
                </div>

                <div class="grid grid-cols-3 gap-2 w-full overflow-y-auto pr-1 max-h-[6.5rem] scroll-smooth">
                    ${seed.skills.map(skill => `
                        <span class="text-center text-md p-2 ${seed.matchingSkills.includes(skill) ? 
                            'bg-[#65956C] text-white' : 'border border-gray-300 bg-white'} rounded-md">
                            ${skill}
                        </span>
                    `).join('')}
                </div>
            </div>

            <div class="flex flex-col flex-1 text-[#3D3D3D] text-md gap-1 mt-4">
                <span class="flex items-center gap-2">
                    <i class="fas fa-door-open text-[#65956C]"></i>
                    <strong class="text-[#3D3D3D]">Vacancies:</strong> ${seed.positionsAvailable !== undefined ? seed.positionsAvailable : 'N/A'}
                </span>
                <span class="flex items-center gap-2">
                    <i class="fas fa-users text-[#65956C]"></i>
                    <strong class="text-[#3D3D3D]">Needed:</strong> ${seed.positionsNeeded || 'N/A'}
                </span>
            </div>

            ${seed.isPriority ? `
                <div class="mt-2 text-[#3D6585] font-semibold">
                    <i class="fas fa-star"></i> Priority - This employer liked your profile
                </div>
            ` : ''}

            ${isNurtured ? `
                <div class="mt-4 text-[#65956C] font-semibold">
                    <i class="fas fa-heart"></i> You've liked this job
                </div>
            ` : ''}

            ${isApplied ? `
                <div class="mt-2 text-[#65956C] font-semibold">
                    <i class="fas fa-paper-plane"></i> You've applied to this job
                </div>
            ` : ''}
        `;


            jobCardsContainer.innerHTML = seedCardHTML;

            // Update button states
            if (isNurtured) {
                nurtureBtn.disabled = true;
                nurtureBtn.classList.add('opacity-50');
            } else {
                nurtureBtn.disabled = false;
                nurtureBtn.classList.remove('opacity-50');
            }
        }

        // Format post date
        function formatPostDate(date) {
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));

            if (days === 0) return 'Today';
            if (days === 1) return 'Yesterday';
            if (days < 7) return `${days} days ago`;
            if (days < 30) return `${Math.floor(days / 7)} week${Math.floor(days / 7) > 1 ? 's' : ''} ago`;
            return date.toLocaleDateString();
        }

        // Pass on current seed
        async function passCurrentSeed() {
            if (currentSeedIndex >= availableSeeds.length) return;

            // Animation
            jobCardsContainer.classList.add('opacity-0', 'transition-opacity', 'duration-300');

            setTimeout(() => {
                currentSeedIndex++;
                jobCardsContainer.classList.remove('opacity-0');
                displayCurrentSeed();
            }, 300);
        }

        // Nurture current seed
        async function nurtureCurrentSeed() {
            if (currentSeedIndex >= availableSeeds.length) return;
            const seed = availableSeeds[currentSeedIndex];

            if (nurturedSeedIds.has(seed.id)) {
                showToastMessage("You've already liked this job!");
                return;
            }

            try {
                // Create a clean seed object with only the fields we need
                const seedToSave = {
                    id: seed.id,
                    jobTitle: seed.jobTitle || 'No title',
                    companyName: seed.companyName || 'No company',
                    location: seed.location || 'No location',
                    offer: seed.offer || 'No offer details',
                    skills: seed.skills || [],
                    matchingSkills: seed.matchingSkills || [],
                    createdAt: new Date()
                };

                // Add to nurtured seeds in Firestore
                await updateDoc(doc(db, 'careerstepEmployees', currentUser.uid), {
                    nurturedSeeds: arrayUnion(seedToSave)
                });

                nurturedSeedIds.add(seed.id);
                showToastMessage("Job saved to your liked jobs!");

                // Animation
                jobCardsContainer.classList.add('opacity-0', 'transition-opacity', 'duration-300');

                setTimeout(() => {
                    currentSeedIndex++;
                    jobCardsContainer.classList.remove('opacity-0');
                    displayCurrentSeed();
                }, 300);

            } catch (error) {
                console.error('Error saving nurtured seed:', error);
                showToastMessage("Failed to save job: " + (error.message || error));
            }
        }

        // Show toast message
        function showToastMessage(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-[#65956C] text-white px-4 py-2 rounded-md shadow-lg';
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 2000);
        }

        // Handle swipe gestures
        function handleSwipe() {
            const threshold = 50; // Minimum swipe distance
            const swipeDistance = touchEndX - touchStartX;

            if (swipeDistance > threshold) {
                nurtureCurrentSeed();
            } else if (swipeDistance < -threshold) {
                passCurrentSeed();
            }
        }

        // Show login prompt
        function showLoginPrompt() {
            loadingScreen.classList.add('hidden');
            loginPrompt.classList.remove('hidden');
        }

        // Show the app after loading
        function showApp() {
            try {
                document.getElementById('loadingScreen')?.classList?.add('hidden');
                document.getElementById('loginPrompt')?.classList?.add('hidden');
            } catch (e) {
                console.log("Loading elements not found");
            }
        }
    </script>
</body>

</html>