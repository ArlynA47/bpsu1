<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="../images/hirna-logo.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="../css/output.css">
    <title>HirNa!</title>
</head>

<body class="min-h-screen overflow-y-auto">
    <!-- Navigation Bar -->
    <nav class="flex justify-between bg-[#232323] py-2.5 px-10">
        <div class="flex flex-1 justify-start items-end gap-2 ">
            <img src="../images/hirna-logo.png" alt="HirNa Logo" class="h-10 w-10">
        </div>

        <div class="flex flex-2 justify-between items-center gap-6">
            <a href="./employee-home.html" class="flex-1 text-center text-white hover:text-gray-300">Home</a>
            <a href="./employee-browse-jobs.html" class="flex-1 text-center text-white hover:text-gray-300">Browse
                Jobs</a>
            <a href="./employee-liked-jobs.html" class="flex-1 text-center text-white hover:text-gray-300">Liked
                Jobs</a>
        </div>

        <div class="flex flex-1 justify-end items-center gap-4">
            <a href="./employee-profile.html"
                class="bg-[#315E26] text-white px-4 py-2 rounded hover:bg-[#3F742F] cursor-pointer">
                Profile
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="flex flex-col p-10 gap-8">
        <h3 class="text-[#3D3D3D] text-3xl font-semibold">Liked Jobs</h3>
        <!-- Liked Jobs -->
        <div class="grid grid-cols-2 gap-6" id="likedEmployeesContainer">
            <!-- Content will be loaded dynamically -->
            <p class="text-[#545454] text-lg col-span-2">Loading liked jobs...</p>
        </div>

        <h3 class="text-[#3D3D3D] text-3xl font-semibold mt-8">Hired Jobs</h3>
        <!-- Liked Jobs -->
        <div class="grid grid-cols-2 gap-6" id="hiredJobsList">
            <!-- Content will be loaded dynamically -->
            <p class="text-[#545454] text-lg col-span-2">Loading hired jobs...</p>
        </div>
    </div>


    <!-- Hired Job Details Modal -->
    <div id="hiredJobModal" class="fixed inset-0 z-50 overflow-y-auto bg-black/50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl shadow-lg w-full max-w-2xl max-h-[90vh] flex flex-col">
                <!-- Header -->
                <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-[#3D3D3D]">Job Details</h2>
                    <button id="closeHiredModalBtn" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Body (scrollable if needed) -->
                <div id="hiredJobDetails" class="px-6 py-8 overflow-y-auto flex-1">
                    <!-- Details will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <div id="analysisModal" class="fixed inset-0 z-50 overflow-y-auto bg-black/50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl shadow-lg w-full max-w-2xl max-h-[90vh] flex flex-col">
                <!-- Header -->
                <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-[#3D3D3D]">Application Analysis</h2>
                    <button id="closeAnalysisModalBtn" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Body (scrollable if needed) -->
                <div id="analysisResults" class="px-6 py-8 overflow-y-auto flex-1">
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import {
            initializeApp
        } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            getDocs,
            collection,
            query,
            where,
            addDoc,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCM1QSKbZH9Ih3RHv39nQipYoti8Yrji_M",
            authDomain: "careerstep-bpsu1.firebaseapp.com",
            projectId: "careerstep-bpsu1",
            storageBucket: "careerstep-bpsu1.appspot.com",
            messagingSenderId: "17047315291",
            appId: "1:17047315291:web:dc2c9312e3d5b0ced5307e"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const likedContainer = document.getElementById('likedEmployeesContainer');
        const hiredJobsList = document.getElementById('hiredJobsList');
        const hiredJobModal = document.getElementById('hiredJobModal');
        const hiredJobDetails = document.getElementById('hiredJobDetails');
        const analysisModal = document.getElementById('analysisModal');
        const analysisResults = document.getElementById('analysisResults');

        let currentUserData = null;
        let appliedJobIds = new Set();

        let isZeroReputationData = false;
        let isZeroCompetition = false;
        let employerLikeBonus = 0;

        // Modal handlers
        document.getElementById('closeHiredModalBtn').addEventListener('click', () => hiredJobModal.classList.add('hidden'));
        document.getElementById('closeAnalysisModalBtn').addEventListener('click', () => analysisModal.classList.add('hidden'));

        // Auth Check
        onAuthStateChanged(auth, async (user) => {
            highlightCurrentNavLink();
            
            if (!user) {
                window.location.href = './login.html';
            }

            // Get all applications
            const appsQuery = query(collection(db, 'applications'), where('applicantId', '==', user.uid));
            const appsSnapshot = await getDocs(appsQuery);

            if (appsSnapshot.empty) {
                window.location.href = './login.html';
            }

            // Separate hired jobs from other applications
            const hiredJobs = [];
            const otherApplications = new Set();

            appsSnapshot.forEach(doc => {
                const appData = doc.data();
                if (appData.status === 'hired') {
                    hiredJobs.push({
                        id: appData.jobId,
                        applicationId: doc.id,
                        hiredDate: appData.updatedAt || appData.appliedAt || serverTimestamp()
                    });
                } else {
                    otherApplications.add(appData.jobId);
                }
            });

            // Load and display hired jobs
            if (hiredJobs.length > 0) {
                hiredJobsList.innerHTML = '';

                const hiredJobPromises = hiredJobs.map(async (hiredJob) => {
                    const jobDoc = await getDoc(doc(db, 'jobSeeds', hiredJob.id));
                    if (!jobDoc.exists()) return null;

                    const jobData = jobDoc.data();
                    const employerData = jobData.employerId ?
                        (await getDoc(doc(db, 'employers', jobData.employerId))).data() :
                        null;

                    // Convert Firebase Timestamp to readable date
                    const hiredDate = hiredJob.hiredDate.toDate().toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });

                    return generateHiredJobCard(jobData, employerData, hiredDate, hiredJob.id, hiredJob.applicationId);
                });

                const hiredJobCards = (await Promise.all(hiredJobPromises)).filter(card => card !== null);
                hiredJobsList.innerHTML = hiredJobCards.join('');
            }

            // Load and display other liked jobs
            const userDoc = await getDoc(doc(db, 'careerstepEmployees', user.uid));
            if (!userDoc.exists()) return;

            currentUserData = userDoc.data();
            const nurturedSeeds = currentUserData.nurturedSeeds || [];
            const likedContainer = document.getElementById('likedEmployeesContainer');

            const jobCardPromises = nurturedSeeds.map(async (seed) => {
                // Skip if this is a hired job (already displayed above)
                if (hiredJobs.some(job => job.id === seed.id)) return null;

                const seedDoc = await getDoc(doc(db, 'jobSeeds', seed.id));
                if (!seedDoc.exists()) return null;

                const jobData = seedDoc.data();
                const employerData = jobData.employerId ?
                    (await getDoc(doc(db, 'employers', jobData.employerId))).data() :
                    null;

                const isApplied = otherApplications.has(seed.id);
                const likelihoodData = await calculateLikelihoodData(user.uid, seed.id, jobData);

                return generateJobCard(seed, jobData, employerData, isApplied ? 'applied' : null, likelihoodData);
            });

            const jobCards = (await Promise.all(jobCardPromises)).filter(card => card !== null);

            if (jobCards.length > 0) {
                const loadingText = likedContainer.querySelector('p');
                if (loadingText) loadingText.remove();
                likedContainer.innerHTML = jobCards.join('');
            } else {
                likedContainer.innerHTML = '<p class="text-[#545454] text-lg col-span-2">No liked jobs found</p>';
            }

            attachButtonHandlers();
        });

        function generateHiredJobCard(jobData, employerData, hiredDate, jobId, applicationId) {
            return `
                <div class="job-listing-card border-3 rounded-lg p-6 shadow-sm hover:-translate-y-1 hover:shadow-3xl transition-all duration-300 ease-in-out">
                    <!-- Top -->
                    <div class="flex justify-between items-start">
                        <div class="flex flex-col">
                            <span class="text-[#3D3D3D] text-2xl font-bold overflow-hidden whitespace-nowrap text-ellipsis">
                                ${jobData.jobTitle || 'No title'}
                            </span>
                            <span class="text-[#3D3D3D] text-md overflow-hidden whitespace-nowrap text-ellipsis">
                                ${employerData?.companyInfo?.companyName || 'Unknown Company'}
                            </span>
                        </div>
                        <div class="flex flex-col gap-1 items-end">
                            <span class="text-sm px-3 py-1 rounded-lg bg-green-100 text-green-800 font-semibold">
                                Hired on ${hiredDate}
                            </span>
                            <button data-job-id="${jobId}" 
                                    data-application-id="${applicationId}"
                                    class="details-btn text-sm px-3 py-1 text-green-700 hover:underline cursor-pointer font-medium">View Details
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }


        async function showHiredJobDetails(jobId, applicationId) {
            try {
                const jobDoc = await getDoc(doc(db, 'jobSeeds', jobId));
                if (!jobDoc.exists()) throw new Error('Job not found');

                const jobData = jobDoc.data();
                const employerData = jobData.employerId ?
                    (await getDoc(doc(db, 'employers', jobData.employerId))).data() :
                    null;

                let formattedDate = 'Date not available';
                if (applicationId) {
                    const appDoc = await getDoc(doc(db, 'applications', applicationId));
                    if (appDoc.exists()) {
                        const appData = appDoc.data();
                        const dateValue = appData.updatedAt || appData.appliedAt;

                        try {
                            if (dateValue?.toDate) {
                                formattedDate = dateValue.toDate().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                            } else if (dateValue) {
                                const dateObj = new Date(dateValue);
                                if (!isNaN(dateObj.getTime())) {
                                    formattedDate = dateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                                }
                            }
                        } catch (e) {
                            console.error('Error formatting date:', e);
                        }
                    }
                }

                hiredJobDetails.innerHTML = `
                    <div class="w-full bg-white p-5 flex flex-col gap-6 space-y-6">
                        <!-- Header: Job title, company, and badge -->
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex flex-col">
                                <span class="text-[#3D3D3D] text-2xl font-bold overflow-hidden whitespace-nowrap text-ellipsis">
                                    ${jobData.jobTitle || 'No title'}
                                </span>
                                <span class="text-[#3D3D3D] text-md overflow-hidden whitespace-nowrap text-ellipsis">
                                    ${employerData?.companyInfo?.companyName || 'Unknown Company'}
                                </span>
                            </div>
                            <span class="text-sm px-3 py-1 rounded-lg bg-green-100 text-green-800 font-semibold">
                                Hired on ${formattedDate}
                            </span>
                        </div>

                        <!-- Job Offer -->
                        <div class="flex flex-col gap-3">
                            <h3 class="text-[#65956C] text-lg font-bold">Job Offer</h3>
                            <p class="text-[#3D3D3D] text-md leading-relaxed">
                                ${jobData.offer || 'Not specified'}
                            </p>
                        </div>

                        <!-- Job Location -->
                        <div class="flex flex-col gap-3">
                            <h3 class="text-[#65956C] text-lg font-bold">Job Location</h3>
                            <div class="flex flex-wrap gap-2 overflow-y-auto pr-1 max-h-[6.5rem] scroll-smooth">
                                <span class="inline-block text-md px-4 py-1 border border-gray-300 bg-white rounded-md">
                                    ${jobData.location || 'Not specified'}
                                </span>
                            </div>
                        </div>

                        <!-- Skills -->
                        <div class="flex flex-col gap-3">
                            <h3 class="text-[#65956C] text-lg font-bold">Skills Required</h3>
                            <div class="flex flex-wrap gap-2 overflow-y-auto pr-1 max-h-[6.5rem] scroll-smooth">
                                ${(jobData.skills || []).map(skill => `
                                    <span class="inline-block text-md px-4 py-1 rounded-lg border text-center
                                        bg-white border-gray-300 text-[#3D3D3D]">
                                        ${skill}
                                    </span>`).join('') || '<span class="text-sm text-gray-500">Not specified</span>'}
                            </div>
                        </div>

                        <!-- Contact Info -->
                        <div class="flex justify-between flex-1 text-[#3D3D3D] text-md gap-2 mt-4 flex-wrap">
                            <div class="flex flex-col gap-2">
                                <span class="flex items-center gap-2">
                                    <i class="fas fa-envelope text-[#65956C]"></i>
                                    <strong>Email:</strong> ${jobData.employerEmail || 'Not provided'}
                                </span>
                                <span class="flex items-center gap-2">
                                    <i class="fas fa-phone-alt text-[#65956C]"></i>
                                    <strong>Contact:</strong> ${employerData?.companyInfo?.contactNumber || 'Not provided'}
                                </span>
                            </div>
                        </div>
                    </div>
                `;

                hiredJobModal.classList.remove('hidden');
            } catch (error) {
                console.error('Error loading job details:', error);
                hiredJobDetails.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-red-500">Error loading job details. Please try again.</p>
                    </div>
                `;
                hiredJobModal.classList.remove('hidden');
            }
        }


        async function calculateLikelihoodScoreForCard(jobId) {
            try {
                const jobDoc = await getDoc(doc(db, 'jobSeeds', jobId));
                if (!jobDoc.exists()) return 0;

                const jobData = jobDoc.data();
                const likelihoodData = await calculateLikelihoodData(auth.currentUser.uid, jobId, jobData);
                return likelihoodData.likelihoodScore;
            } catch (error) {
                console.error('Error calculating score for card:', error);
                return 0;
            }
        }

        function getTailwindScoreClass(score) {
            if (score >= 80) return 'bg-green-100 text-green-800';
            if (score >= 60) return 'bg-blue-100 text-blue-800';
            if (score >= 40) return 'bg-yellow-100 text-yellow-800';
            return 'bg-red-100 text-red-800';
        }

        function getMatchQualityText(score) {
            if (score >= 80) return 'Excellent Match';
            if (score >= 60) return 'Good Match';
            if (score >= 40) return 'Fair Match';
            return 'Low Match';
        }

        // Create Job Card
        function generateJobCard(seed, jobData, employerData, applicationStatus, likelihoodData) {
            const jobSkills = seed.skills || [];
            const userSkills = currentUserData?.jobPreferences?.skills || [];

            const userSkillsLower = (currentUserData?.jobPreferences?.skills || []).map(skill => skill.toLowerCase());

            const matchedSkills = jobSkills.filter(skill =>
                userSkillsLower.some(userSkill =>
                    userSkill.includes(skill.toLowerCase()) || skill.toLowerCase().includes(userSkill)
                )
            );

            const unmatchedSkills = jobSkills.filter(skill => !matchedSkills.includes(skill));

            // Cap unmatched skills to 3, get remaining for tooltip
            const cappedUnmatchedSkills = unmatchedSkills.slice(0, 3);
            const remainingUnmatchedSkills = unmatchedSkills.slice(3);

            const skillsHTML = [
                ...matchedSkills.map(skill => `
                    <span class="inline-block text-md px-4 py-1 rounded-lg border text-center
                        bg-[#E8F5E9] border-[#73A267] text-[#2E7D32] font-semibold">
                        ${skill}
                    </span>
                `),
                ...cappedUnmatchedSkills.map(skill => `
                    <span class="inline-block text-md px-4 py-1 rounded-lg border text-center
                        bg-white border border-gray-300 text-[#3D3D3D]">
                        ${skill}
                    </span>
                `),
                ...(remainingUnmatchedSkills.length > 0 ? [`
                    <span class="inline-block text-md px-4 py-1 rounded-lg border text-center bg-white border border-gray-300 text-[#3D3D3D]"
                        title="${remainingUnmatchedSkills.join(', ')}">
                        +${remainingUnmatchedSkills.length} more
                    </span>
                `] : [])
            ].join('');


            const locationHTML = `
                <span class="inline-block text-md px-4 py-1 border border-gray-300 bg-white rounded-md">
                    ${seed.location || 'N/A'}
                </span>
            `;

            // Get match quality info
            const matchQuality = getMatchQuality(likelihoodData.likelihoodScore);
            const matchColor = getMatchColor(likelihoodData.likelihoodScore);
            const competitionLevel = getCompetitionLevel(likelihoodData.competitionPercentage);

            return `
                <div class="job-listing-card border rounded-lg p-6 shadow-sm hover:-translate-y-1 hover:shadow-3xl transition-all duration-300 ease-in-out">
                    <!-- Match Quality Badge - Top Right -->
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex flex-col">
                            <span class="flex-1 text-[#3D3D3D] text-2xl font-bold overflow-hidden whitespace-nowrap text-ellipsis">${seed.jobTitle}</span>
                            <span class="flex-1 text-[#3D3D3D] text-md overflow-hidden whitespace-nowrap text-ellipsis">
                                ${employerData?.companyInfo?.companyName || 'Unknown'}
                            </span>
                        </div>
                        <span class="text-sm px-3 py-1 rounded-lg ${matchColor.bg} ${matchColor.text} font-semibold">
                            ${matchQuality} Match
                        </span>
                    </div>

                    <div class="flex flex-col gap-3">
                        <h3 class="text-[#65956C] text-lg font-bold">Job Offer</h3>
                        <p class="text-[#3D3D3D] text-md leading-relaxed">${seed.offer}</p>
                    </div>

                    <div class="flex flex-col gap-3">
                        <h3 class="text-[#65956C] text-lg font-bold">Job Location</h3>
                        <div class="flex flex-wrap gap-2 overflow-y-auto pr-1 max-h-[6.5rem] scroll-smooth">${locationHTML}</div>
                    </div>

                    <div class="flex flex-col gap-3">
                        <div class="flex items-center gap-8">
                            <h3 class="text-[#65956C] text-lg font-bold">Skills Required</h3>
                            <span class="text-center text-xs px-2 py-1 bg-[#65956C] text-white rounded-md">
                                ${getMatchingSkills(seed.skills, currentUserData?.jobPreferences?.skills || []).length}
                                Match${getMatchingSkills(seed.skills, currentUserData?.jobPreferences?.skills || []).length !== 1 ? 'es' : ''}
                            </span>
                        </div>
                        <div class="flex flex-wrap gap-2 overflow-y-auto pr-1 max-h-[6.5rem] scroll-smooth">${skillsHTML}</div>
                    </div>

                    <div class="flex justify-between flex-1 text-[#3D3D3D] text-md gap-2 mt-4">
                        <div class="flex flex-col gap-2">
                            <span><i class="fas fa-door-open text-[#65956C]"></i> <strong>Vacancies:</strong> ${jobData.positionsAvailable}</span>
                            <span><i class="fas fa-users text-[#65956C]"></i> <strong>Needed:</strong> ${jobData.positionsNeeded}</span>
                        </div>
                        <div class="flex flex-col gap-2">
                            <span><i class="fas fa-envelope text-[#65956C]"></i> <strong>Email:</strong> ${jobData.employerEmail || 'N/A'}</span>
                            <span><i class="fas fa-phone-alt text-[#65956C]"></i> <strong>Contact:</strong> ${employerData?.companyInfo?.contactNumber || 'N/A'}</span>
                        </div>
                    </div>

                    <div class="flex gap-2 mt-6">
                        ${applicationStatus === 'hired' ? `
                            <span class="flex-1 text-center bg-green-100 text-green-800 px-4 py-2 rounded cursor-default text-md">
                                <i class="fas fa-check-circle mr-2"></i> Hired
                            </span> 
                        ` : applicationStatus === 'shortlisted' ? `
                            <span class="flex-1 text-center bg-blue-100 text-blue-800 px-4 py-2 rounded cursor-default text-md">
                                <i class="fas fa-list-check mr-2"></i> Shortlisted
                            </span>
                        ` : applicationStatus === 'rejected' ? `
                            <span class="flex-1 text-center bg-red-100 text-red-800 px-4 py-2 rounded cursor-default text-md">
                                <i class="fas fa-times-circle mr-2"></i> Rejected
                            </span>
                        ` : applicationStatus === 'applied' ? `
                            <span class="flex-1 text-center bg-gray-200 text-gray-700 px-4 py-2 rounded cursor-default text-md">
                                <i class="fas fa-paper-plane mr-2"></i> Applied
                            </span>
                        ` : `
                            <button data-job-id="${seed.id}" class="apply-btn flex-1 bg-[#73A267] text-white px-4 py-2 rounded hover:bg-[#5c8651] cursor-pointer text-md">
                                <i class="fas fa-paper-plane mr-2"></i> Apply
                            </button>
                        `}
                        <button data-job-id="${seed.id}" class="analyze-btn flex-1 bg-[#4B6584] text-white px-4 py-2 rounded hover:bg-[#3B5167] cursor-pointer text-md">
                            <i class="fas fa-chart-line mr-2"></i> Details
                        </button>
                    </div>
                </div>`;
        }

        function getStatusDisplayName(status) {
            switch (status) {
                case 'hired': return 'Hired';
                case 'shortlisted': return 'Shortlisted';
                case 'rejected': return 'Rejected';
                case 'applied': return 'Applied';
                default: return 'Apply';
            }
        }

        function getMatchQuality(score) {
            if (score >= 80) return 'Excellent';
            if (score >= 60) return 'Good';
            if (score >= 40) return 'Fair';
            return 'Low';
        }

        function getMatchColor(score) {
            if (score >= 80) return { bg: 'bg-green-100', text: 'text-green-800' };
            if (score >= 60) return { bg: 'bg-blue-100', text: 'text-blue-800' };
            if (score >= 40) return { bg: 'bg-yellow-100', text: 'text-yellow-800' };
            return { bg: 'bg-red-100', text: 'text-red-800' };
        }

        function getCompetitionLevel(percentage) {
            if (percentage >= 80) return 'High';
            if (percentage >= 60) return 'Moderate';
            if (percentage >= 40) return 'Low';
            return 'Very Low';
        }


        // Event Handlers
        function attachButtonHandlers() {
            // Analysis button handlers (for liked jobs)
            document.querySelectorAll('.analyze-btn').forEach(button => {
                button.addEventListener('click', async () => {
                    const jobId = button.getAttribute('data-job-id');
                    analysisModal.classList.remove('hidden');
                    analysisResults.innerHTML = `<div class="text-center">Loading analysis...</div>`;

                    try {
                        const html = await analyzeApplicationChances(jobId);
                        analysisResults.innerHTML = html;
                    } catch (e) {
                        analysisResults.innerHTML = `<div class="text-red-500">Error loading analysis.</div>`;
                        console.error(e);
                    }
                });
            });

            // Apply button handlers (for liked jobs)
            document.querySelectorAll('.apply-btn').forEach(button => {
                button.addEventListener('click', async () => {
                    const jobId = button.getAttribute('data-job-id');
                    const jobDoc = await getDoc(doc(db, 'jobSeeds', jobId));
                    const jobData = jobDoc.data();

                    const likelihood = await calculateLikelihoodData(auth.currentUser.uid, jobId, jobData);

                    await addDoc(collection(db, 'applications'), {
                        applicantId: auth.currentUser.uid,
                        userId: auth.currentUser.uid,
                        jobId,
                        jobTitle: jobData.jobTitle,
                        employerId: jobData.employerId,
                        status: 'applied', // Initial status
                        appliedAt: new Date(),
                        createdAt: new Date(),
                        likelihoodScore: likelihood.likelihoodScore,
                        skillMatch: likelihood.skillMatchPercentage,
                        reputationScore: likelihood.reputationScore
                    });

                    // Refresh the job cards to show the new status
                    window.location.reload();
                });
            });

            // Details button handlers (for hired jobs)
            document.querySelectorAll('.details-btn').forEach(button => {
                button.addEventListener('click', async () => {
                    const jobId = button.getAttribute('data-job-id');
                    const applicationId = button.getAttribute('data-application-id');

                    if (!applicationId) {
                        console.error('No application ID found for this hired job');
                        return;
                    }

                    showHiredJobDetails(jobId, applicationId);
                });
            });
        }

        async function calculateLikelihoodData(userId, jobId, jobData) {
            // Calculate reputation score
            const reputationScore = await calculateReputationScore(userId);

            // Calculate skill match
            const jobSkills = jobData.skills || [];
            const userSkills = currentUserData?.jobPreferences?.skills || [];
            const matchingSkills = getMatchingSkills(jobSkills, userSkills);
            const skillMatchPercentage = jobSkills.length > 0 ?
                Math.round((matchingSkills.length / jobSkills.length) * 100) : 0;

            // Calculate position availability
            const positionsAvailable = jobData.positionsAvailable || 0;
            const positionsNeeded = jobData.positionsNeeded || 1;
            const availabilityPercentage = Math.round((positionsAvailable / positionsNeeded) * 100);

            // Calculate competition (number of applicants)
            const appsQuery = query(collection(db, 'applications'),
                where('jobId', '==', jobId),
                where('status', 'in', ['pending', 'shortlisted', 'hired']));
            const appsSnapshot = await getDocs(appsQuery);

            let strongerApplicants = 0;
            let totalApplicants = 0;

            // Check if employer liked this employee
            try {
                const jobDoc = await getDoc(doc(db, 'jobSeeds', jobId));
                if (jobDoc.exists()) {
                    const jobData = jobDoc.data();
                    const employerId = jobData.employerId;

                    if (employerId) {
                        const employeeDoc = await getDoc(doc(db, 'careerstepPublicProfiles', userId));
                        if (employeeDoc.exists()) {
                            const employeeData = employeeDoc.data();
                            const likedByEmployers = employeeData.likedByEmployers || [];

                            console.log("likedByEmployers:", likedByEmployers);
                            console.log("employerId: ", employerId);

                            if (likedByEmployers.some(like => like.employerId === employerId)) {
                                employerLikeBonus = 15; // Add 15% bonus if employer liked this employee
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error checking employer like:', error);
            }

            // Get current user's score first
            const userScore = Math.round(
                (reputationScore * 0.4) +
                (skillMatchPercentage * 0.4) +
                (availabilityPercentage * 0.2)
            );

            // Compare with other applicants
            for (const appDoc of appsSnapshot.docs) {
                const appData = appDoc.data();
                if (appData.applicantId !== userId) {
                    totalApplicants++;
                    const otherUserScore = appData.likelihoodScore ||
                        await calculateApplicantScore(appData.applicantId, jobId, jobData);
                    if (otherUserScore > userScore) {
                        strongerApplicants++;
                    }
                }
            }

            if (totalApplicants > 0) {
                isZeroCompetition = false;
            } else {
                isZeroCompetition = true;
            }

            const competitionPercentage = totalApplicants > 0 ?
                Math.round((strongerApplicants / totalApplicants) * 100) : 0;

            // Calculate likelihood score (weighted average)
            const likelihoodScore = Math.round(
                (reputationScore * 0.4) +
                (skillMatchPercentage * 0.4) +
                (availabilityPercentage * 0.2)
            );


            return {
                reputationScore,
                skillMatchPercentage,
                availabilityPercentage,
                totalApplicants,
                strongerApplicants,
                competitionPercentage,
                likelihoodScore
            };
        }


        async function analyzeApplicationChances(jobId) {
            try {
                const user = auth.currentUser;
                if (!user) throw new Error('User not logged in');

                const jobDoc = await getDoc(doc(db, 'jobSeeds', jobId));
                if (!jobDoc.exists()) throw new Error('Job not found');

                const jobData = jobDoc.data();
                const likelihoodData = await calculateLikelihoodData(user.uid, jobId, jobData);

                const matchQuality = getMatchQuality(likelihoodData.likelihoodScore);
                const matchColor = getMatchColor(likelihoodData.likelihoodScore);
                const competitionLevel = getCompetitionLevel(likelihoodData.competitionPercentage);
                likelihoodData.employerLikeBonus = employerLikeBonus;

                let reputationScore = "";
                let competitionStr = "";

                if (isZeroReputationData) {
                    reputationScore = "No records";
                } else {
                    reputationScore = likelihoodData.reputationScore;
                }


                if (isZeroCompetition) {
                    competitionStr = "No Applicants";
                } else {
                    competitionStr = "Stronger than " + (100 - likelihoodData.competitionPercentage) + "% of " + likelihoodData.totalApplicants + " applicants";
                }

                // Generate Tailwind-based modal content
                return `
                    <div class="flex flex-col gap-8 text-[#3D3D3D] p-6">
                        <div class="text-center">
                            <h3 class="text-2xl font-bold mb-4">Your Application Strength</h3>
                            <div class="w-40 h-40 mx-auto flex items-center justify-center rounded-full ${matchColor.bg} shadow-lg">
                                <span class="${matchColor.text} text-2xl font-bold">${matchQuality}</span>
                            </div>
                            <div class="text-sm text-gray-600 mt-3">
                                Overall Strength Score: ${likelihoodData.likelihoodScore}
                            </div>
                        </div>

                        ${likelihoodData.employerLikeBonus > 0 ? `
                            <div class="flex items-start gap-3 bg-blue-50 border border-blue-300 text-blue-800 p-4 rounded-lg shadow-sm mt-3">
                                <div>
                                    <p class="font-semibold">Employer Interest</p>
                                    <p class="text-sm">This employer previously liked your profile!
                                </div>
                            </div>
                        ` : ''}

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-center">
                            <div class="p-4 border rounded-lg shadow-sm">
                                <h4 class="text-lg font-semibold mb-2">Reputation Score</h4>
                                <p class="text-2xl font-bold text-[#65956C]">${reputationScore}</p>
                                <p class="text-sm text-gray-600 mt-1">Based on employer feedback</p>
                            </div>
                            <div class="p-4 border rounded-lg shadow-sm">
                                <h4 class="text-lg font-semibold mb-2">Skill Match</h4>
                                <p class="text-2xl font-bold text-[#65956C]">${likelihoodData.skillMatchPercentage}%</p>
                                <p class="text-sm text-gray-600 mt-1">${getMatchingSkills(jobData.skills || [], currentUserData?.jobPreferences?.skills || []).length} of ${jobData.skills?.length || 0} required skills matched</p>
                            </div>
                            <div class="p-4 border rounded-lg shadow-sm">
                                <h4 class="text-lg font-semibold mb-2">Position Availability</h4>
                                <p class="text-2xl font-bold text-[#65956C]">${likelihoodData.availabilityPercentage}%</p>
                                <p class="text-sm text-gray-600 mt-1">${jobData.positionsAvailable || 0} of ${jobData.positionsNeeded || 1} positions available</p>
                            </div>
                            <div class="p-4 border rounded-lg shadow-sm">
                                <h4 class="text-lg font-semibold mb-2">Competition</h4>
                                <p class="text-2xl font-bold text-[#65956C]">${competitionLevel}</p>
                                <p class="text-sm text-gray-600 mt-1">
                                    ${competitionStr}
                                </p>
                            </div>
                        </div>

                        <div class="flex flex-col gap-4 text-left">
                            <h4 class="text-xl font-bold">Skill Analysis</h4>
                            <div>
                                <h5 class="text-green-700 font-semibold mb-2">✓ Matched Skills (${getMatchingSkills(jobData.skills, currentUserData?.jobPreferences?.skills || []).length})</h5>
                                <div class="flex flex-wrap gap-2">
                                    ${getMatchingSkills(jobData.skills, currentUserData?.jobPreferences?.skills || []).map(skill => `
                                        <span class="inline-block text-md px-4 py-1 rounded-lg border text-center 
                                                    bg-[#E8F5E9] border-[#73A267] text-[#2E7D32]">${skill}</span>
                                    `).join('')}
                                </div>
                            </div>

                            ${getMissingSkills(jobData.skills, currentUserData?.jobPreferences?.skills || []).length > 0 ? `
                                <div>
                                    <h5 class="text-red-700 font-semibold mt-4 mb-2">✗ Missing Skills (${getMissingSkills(jobData.skills, currentUserData?.jobPreferences?.skills || []).length})</h5>
                                    <div class="flex flex-wrap gap-2">
                                        ${getMissingSkills(jobData.skills, currentUserData?.jobPreferences?.skills || []).map(skill => `
                                            <span class="inline-block text-md px-4 py-1 rounded-lg border text-center 
                                                    bg-red-100 border-red-800 text-red-800">${skill}</span>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>

                        <div class="flex flex-col gap-2 mt-4 text-left">
                            <h4 class="text-xl font-bold">Recommendations</h4>
                            ${getRecommendations(
                    likelihoodData.likelihoodScore,
                    getMatchingSkills(jobData.skills, currentUserData?.jobPreferences?.skills || []),
                    jobData.skills || []
                )}
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error analyzing application:', error);
                throw error;
            }
        }

        function highlightCurrentNavLink() {
            const currentPath = window.location.pathname.split('/').pop(); // Get the filename, e.g., 'employee-home.html'
            const navLinks = document.querySelectorAll('nav a');

            navLinks.forEach(link => {
                const linkPath = link.getAttribute('href').split('/').pop();
                if (linkPath === currentPath) {
                    link.classList.add('underline', 'underline-offset-4');
                }
            });
        }

        function getQualityFromScore(score) {
            if (score >= 80) return 'Excellent';
            if (score >= 60) return 'Good';
            if (score >= 40) return 'Fair';
            return 'Low';
        }

        function getAvailabilityLevel(available, needed) {
            const percentage = available / needed;
            if (percentage >= 0.8) return 'High';
            if (percentage >= 0.5) return 'Moderate';
            if (percentage >= 0.2) return 'Low';
            return 'Very Low';
        }

        async function calculateReputationScore(userId) {
            try {
                const feedbackQuery = query(
                    collection(db, 'employeeFeedback'),
                    where('employeeId', '==', userId)
                );
                const feedbackSnapshot = await getDocs(feedbackQuery);

                let positiveCount = 0;
                let totalCount = 0;

                feedbackSnapshot.forEach(doc => {
                    const feedback = doc.data();
                    if (feedback.rating === 'positive') positiveCount++;
                    totalCount++;
                });

                if (totalCount > 0) {
                    isZeroReputationData = false;
                    return Math.round((positiveCount / totalCount) * 100);
                } else {
                    isZeroReputationData = true;
                    return 75;
                }
            } catch (error) {
                console.error('Error calculating reputation:', error);
                return 75;
            }
        }

        function getMatchingSkills(jobSkills, userSkills) {
            if (!jobSkills || jobSkills.length === 0) return [];
            if (!userSkills || userSkills.length === 0) return [];

            return jobSkills.filter(jobSkill =>
                userSkills.some(userSkill =>
                    userSkill.toLowerCase().includes(jobSkill.toLowerCase()) ||
                    jobSkill.toLowerCase().includes(userSkill.toLowerCase())
                )
            );
        }

        function getMissingSkills(jobSkills, userSkills) {
            if (!jobSkills || jobSkills.length === 0) return [];
            return jobSkills.filter(skill => !getMatchingSkills(jobSkills, userSkills).includes(skill));
        }

        function getScoreDescription(score) {
            if (score >= 80) return 'Excellent Match';
            if (score >= 60) return 'Good Match';
            if (score >= 40) return 'Fair Match';
            return 'Low Match';
        }

        function getScoreClass(score) {
            if (score >= 80) return 'score-green';
            if (score >= 60) return 'score-blue';
            if (score >= 40) return 'score-yellow';
            return 'score-red';
        }

        function getTailwindColor(score) {
            if (score >= 80) return 'green';
            if (score >= 60) return 'blue';
            if (score >= 40) return 'yellow';
            return 'red';
        }

        function getRecommendations(score, matchingSkills, jobSkills) {
            const missingSkills = getMissingSkills(jobSkills, currentUserData?.jobPreferences?.skills || []);
            const skillsList = missingSkills.length > 0 ? missingSkills.join(', ') : null;

            if (score >= 80) {
                return `
            <div class="p-4 bg-green-100 text-green-800 rounded-lg shadow-sm">
                <strong>Excellent match!</strong> You have a very high chance of getting hired.
                ${skillsList ? `<br>Consider brushing up on: <span class="font-semibold">${skillsList}</span>` : ''}
            </div>
        `;
            } else if (score >= 60) {
                return `
            <div class="p-4 bg-blue-100 text-blue-800 rounded-lg shadow-sm">
                <strong>Good match!</strong> You have a decent chance, but there's room to grow.
                ${skillsList ? `<br>Focus on developing: <span class="font-semibold">${skillsList}</span>` : ''}
            </div>
        `;
            } else if (score >= 40) {
                return `
            <div class="p-4 bg-yellow-100 text-yellow-800 rounded-lg shadow-sm">
                <strong>Fair match.</strong> Your chances are moderate.
                ${skillsList ? `<br>Consider improving: <span class="font-semibold">${skillsList}</span>` : 'Consider enhancing your skills.'}
            </div>
        `;
            } else {
                return `
            <div class="p-4 bg-red-100 text-red-800 rounded-lg shadow-sm">
                <strong>Low match.</strong> This position may not be the best fit.
                ${skillsList ? `<br>You're missing key skills: <span class="font-semibold">${skillsList}</span>` : ''}
                <br>Look for roles that align more closely with your skillset.
            </div>
        `;
            }
        }
    </script>
</body>

</html>